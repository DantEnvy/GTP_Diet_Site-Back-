import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
// import fetch from 'node-fetch'; // Ð¯ÐºÑ‰Ð¾ Ð²Ð¸Ð½Ð¸ÐºÐ°Ñ” Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ° "fetch is not defined" Ð½Ð° ÑÑ‚Ð°Ñ€Ð¸Ñ… Ð½Ð¾Ð´Ð°Ñ…, Ñ€Ð¾Ð·ÐºÐ¾Ð¼ÐµÐ½Ñ‚ÑƒÐ¹Ñ‚Ðµ Ñ†Ðµ (Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½ÑŒÐ¾ Ð·Ñ€Ð¾Ð±Ð¸Ð²ÑˆÐ¸ npm install node-fetch)
// ÐÐ»Ðµ Ð½Ð° Node 18+ fetch Ð²Ð±ÑƒÐ´Ð¾Ð²Ð°Ð½Ð¸Ð¹.

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

app.post('/', async (req, res) => { 
    try {
        console.log("ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾ Ð·Ð°Ð¿Ð¸Ñ‚:", req.body);
        const { age, height, weight, gender, bmr, protein, fat, carb, allergy, health, vitamins } = req.body;
        const API_KEY = process.env.GOOGLE_API_KEY; 
        
        if (!API_KEY) {
            return res.status(500).json({ error: "GOOGLE_API_KEY Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ñ–" });
        }

        const promptText = `

Ð¢Ð¸ Ñ” Ð¿Ñ€Ð¾Ñ„ÐµÑÑ–Ð¹Ð½Ð¸Ð¼ Ð´Ñ–Ñ”Ñ‚Ð¾Ð»Ð¾Ð³Ð¾Ð¼ Ñ– Ð½ÑƒÑ‚Ñ€Ð¸Ñ†Ñ–Ð¾Ð»Ð¾Ð³Ð¾Ð¼. Ð¢Ð²Ð¾Ñ” Ð·Ð°Ð²Ð´Ð°Ð½Ð½Ñ â€” ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ– Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ñ–Ñ— Ð· Ñ…Ð°Ñ€Ñ‡ÑƒÐ²Ð°Ð½Ð½Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ñ– Ð½Ð°Ð´Ð°Ð½Ð¸Ñ… Ð´Ð°Ð½Ð¸Ñ… Ð»ÑŽÐ´Ð¸Ð½Ð¸.

Ð’Ñ…Ñ–Ð´Ð½Ñ– Ð´Ð°Ð½Ñ– ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°:
Ð’Ñ–Ðº: ${age}
Ð—Ñ€Ñ–ÑÑ‚: ${height} ÑÐ¼
Ð’Ð°Ð³Ð°: ${weight} ÐºÐ³
Ð¡Ñ‚Ð°Ñ‚ÑŒ: ${gender}
ÐÐ»ÐµÑ€Ð³Ñ–Ñ—: ${allergy}
Ð¡Ñ‚Ð°Ð½ Ð·Ð´Ð¾Ñ€Ð¾Ð²'Ñ: ${health}
Ð”Ð¾Ð±Ð¾Ð²Ñ– Ð½Ð¾Ñ€Ð¼Ð¸:
ÐšÐ°Ð»Ð¾Ñ€Ñ–Ñ—: ${bmr} ÐºÐºÐ°Ð»
Ð‘Ñ–Ð»ÐºÐ¸: ${protein} Ð³
Ð–Ð¸Ñ€Ð¸: ${fat} Ð³
Ð’ÑƒÐ³Ð»ÐµÐ²Ð¾Ð´Ð¸: ${carb} Ð³
Ð’Ñ–Ñ‚Ð°Ð¼Ñ–Ð½Ð¸ Ñ‚Ð° Ð¼Ñ–ÐºÑ€Ð¾ÐµÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¸ Ð½Ð° Ð´ÐµÐ½ÑŒ: ${vitamins}

Ð—Ð°Ð²Ð´Ð°Ð½Ð½Ñ:
ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ñ– Ñ†Ð¸Ñ… Ð´Ð°Ð½Ð¸Ñ… ÑÐºÐ»Ð°Ð´Ð¸ Ð¿Ð¾Ð²Ð½Ð¾Ñ†Ñ–Ð½Ð½Ð¸Ð¹ Ñ€Ð°Ñ†Ñ–Ð¾Ð½ Ñ…Ð°Ñ€Ñ‡ÑƒÐ²Ð°Ð½Ð½Ñ Ð½Ð° 7 Ð´Ð½Ñ–Ð².

ÐšÐ¾Ð¶ÐµÐ½ Ð´ÐµÐ½ÑŒ Ð¿Ð¾Ð²Ð¸Ð½ÐµÐ½ Ð¼Ñ–ÑÑ‚Ð¸Ñ‚Ð¸ ÑÐ½Ñ–Ð´Ð°Ð½Ð¾Ðº, Ð¾Ð±Ñ–Ð´, Ð²ÐµÑ‡ÐµÑ€ÑŽ Ñ‚Ð° Ð·Ð° Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸ 1â€“2 Ð¿ÐµÑ€ÐµÐºÑƒÑÐ¸.

Ð”Ð»Ñ ÐºÐ¾Ð¶Ð½Ð¾Ñ— ÑÑ‚Ñ€Ð°Ð²Ð¸ Ð¾Ð±Ð¾Ð²â€™ÑÐ·ÐºÐ¾Ð²Ð¾ Ð²ÐºÐ°Ð·ÑƒÐ¹:
ÐÐ°Ð·Ð²Ñƒ ÑÑ‚Ñ€Ð°Ð²Ð¸.
Ð¡ÐºÐ»Ð°Ð´ Ñ–Ð½Ð³Ñ€ÐµÐ´Ñ–Ñ”Ð½Ñ‚Ñ–Ð² Ñ–Ð· Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¼Ð¸ Ð²Ð°Ð³Ð°Ð¼Ð¸.
ÐšÐ°Ð»Ð¾Ñ€Ñ–Ð¹Ð½Ñ–ÑÑ‚ÑŒ.
ÐšÑ–Ð»ÑŒÐºÑ–ÑÑ‚ÑŒ Ð±Ñ–Ð»ÐºÑ–Ð², Ð¶Ð¸Ñ€Ñ–Ð² Ñ– Ð²ÑƒÐ³Ð»ÐµÐ²Ð¾Ð´Ñ–Ð².
ÐžÑÐ½Ð¾Ð²Ð½Ñ– Ð²Ñ–Ñ‚Ð°Ð¼Ñ–Ð½Ð¸ Ñ‚Ð° Ð¼Ñ–Ð½ÐµÑ€Ð°Ð»Ð¸, ÑÐºÑ– Ð¼Ñ–ÑÑ‚ÑÑ‚ÑŒÑÑ Ñƒ ÑÑ‚Ñ€Ð°Ð²Ñ–.

Ð¡ÑƒÐ¼Ð°Ñ€Ð½Ñ– Ð¿Ð¾ÐºÐ°Ð·Ð½Ð¸ÐºÐ¸ Ð·Ð° Ð´ÐµÐ½ÑŒ Ð¿Ð¾Ð²Ð¸Ð½Ð½Ñ– Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ‚Ð¸ Ð·Ð°Ð´Ð°Ð½Ð¸Ð¼ Ð½Ð¾Ñ€Ð¼Ð°Ð¼ ÐºÐ°Ð»Ð¾Ñ€Ñ–Ð¹, Ð±Ñ–Ð»ÐºÑ–Ð², Ð¶Ð¸Ñ€Ñ–Ð² Ñ– Ð²ÑƒÐ³Ð»ÐµÐ²Ð¾Ð´Ñ–Ð². Ð Ð°Ñ†Ñ–Ð¾Ð½ Ð¼Ð°Ñ” Ð¿Ð¾ÐºÑ€Ð¸Ð²Ð°Ñ‚Ð¸ Ð´Ð¾Ð±Ð¾Ð²Ñƒ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ñƒ Ñƒ Ð²Ñ–Ñ‚Ð°Ð¼Ñ–Ð½Ð°Ñ… Ð±ÐµÐ· Ð¿ÐµÑ€ÐµÐ²Ð¸Ñ‰ÐµÐ½Ð½Ñ Ð±ÐµÐ·Ð¿ÐµÑ‡Ð½Ð¸Ñ… Ð´Ð¾Ð·.

Ð¡Ñ‚Ñ€Ð¾Ð³Ð¾ Ð²Ð¸ÐºÐ»ÑŽÑ‡Ð¸ Ð²ÑÑ– Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð¸, ÑÐºÑ– Ð½Ðµ Ð¼Ð¾Ð¶Ð½Ð° Ð²Ð¶Ð¸Ð²Ð°Ñ‚Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð°Ð»ÐµÑ€Ð³Ñ–Ñ—, Ð·Ð°Ñ…Ð²Ð¾Ñ€ÑŽÐ²Ð°Ð½Ð½Ñ Ð°Ð±Ð¾ Ñ‚Ñ€Ð°Ð²Ð¼Ð¸.

Ð Ð°Ñ†Ñ–Ð¾Ð½ Ð¿Ð¾Ð²Ð¸Ð½ÐµÐ½ Ð±ÑƒÑ‚Ð¸ Ñ€ÐµÐ°Ð»Ñ–ÑÑ‚Ð¸Ñ‡Ð½Ð¸Ð¼, ÑÐºÐ»Ð°Ð´Ð°Ñ‚Ð¸ÑÑ Ð·Ñ– Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð¸Ñ… Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ–Ð², Ð½Ðµ Ð¼Ñ–ÑÑ‚Ð¸Ñ‚Ð¸ ÐµÐºÐ·Ð¾Ñ‚Ð¸Ñ‡Ð½Ð¸Ñ… Ð°Ð±Ð¾ Ð½Ð°Ð´Ñ‚Ð¾ Ð´Ð¾Ñ€Ð¾Ð³Ð¸Ñ… Ñ–Ð½Ð³Ñ€ÐµÐ´Ñ–Ñ”Ð½Ñ‚Ñ–Ð², Ð±ÑƒÑ‚Ð¸ Ð·Ð±Ð°Ð»Ð°Ð½ÑÐ¾Ð²Ð°Ð½Ð¸Ð¼ Ñ– Ñ€Ñ–Ð·Ð½Ð¾Ð¼Ð°Ð½Ñ–Ñ‚Ð½Ð¸Ð¼.

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ–:
ÐžÐºÑ€ÐµÐ¼Ð¸Ð¹ Ð±Ð»Ð¾Ðº Ð´Ð»Ñ ÐºÐ¾Ð¶Ð½Ð¾Ð³Ð¾ Ð´Ð½Ñ Ð· Ð¿Ð¾Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½ÑÐ¼ Ð”ÐµÐ½ÑŒ 1 â€“ Ð”ÐµÐ½ÑŒ 7.
Ð§Ñ–Ñ‚ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð°Ð±Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ Ð´Ð»Ñ ÐºÐ¾Ð¶Ð½Ð¾Ð³Ð¾ Ð´Ð½Ñ.
Ð’ ÐºÑ–Ð½Ñ†Ñ– ÐºÐ¾Ð¶Ð½Ð¾Ð³Ð¾ Ð´Ð½Ñ Ð½Ð°Ð´Ð°Ð¹ Ð¿Ñ–Ð´ÑÑƒÐ¼Ð¾Ðº Ð·Ð° Ð´ÐµÐ½ÑŒ: ÐºÐ°Ð»Ð¾Ñ€Ñ–Ñ—, Ð±Ñ–Ð»ÐºÐ¸, Ð¶Ð¸Ñ€Ð¸, Ð²ÑƒÐ³Ð»ÐµÐ²Ð¾Ð´Ð¸.
ÐŸÑ–ÑÐ»Ñ Ð²ÑÑŒÐ¾Ð³Ð¾ Ñ€Ð°Ñ†Ñ–Ð¾Ð½Ñƒ Ð´Ð¾Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÑ– Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ñ– Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ñ–Ñ— Ñ‰Ð¾Ð´Ð¾ Ð²Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼Ñƒ Ñ‚Ð° Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¸Ñ… Ð·Ð°Ð¼Ñ–Ð½ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ–Ð².

ÐÐµ Ð½Ð°Ð´Ð°Ð²Ð°Ð¹ Ð¼ÐµÐ´Ð¸Ñ‡Ð½Ð¸Ñ… Ð¿Ð¾Ñ€Ð°Ð´, Ð»Ð¸ÑˆÐµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ñ–Ñ— Ð· Ñ…Ð°Ñ€Ñ‡ÑƒÐ²Ð°Ð½Ð½Ñ.
Ð¯ÐºÑ‰Ð¾ ÑÐºÐ¸Ñ…Ð¾ÑÑŒ Ð´Ð°Ð½Ð¸Ñ… Ð½Ðµ Ð²Ð¸ÑÑ‚Ð°Ñ‡Ð°Ñ”, ÑÐ²Ð½Ð¾ Ð²ÐºÐ°Ð¶Ð¸ Ð·Ñ€Ð¾Ð±Ð»ÐµÐ½Ñ– Ð¿Ñ€Ð¸Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ.

Ð’Ð¸Ð²ÐµÐ´Ð¸ Ñƒ JSON Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ–`;

        // Ð’Ð˜ÐšÐžÐ Ð˜Ð¡Ð¢ÐžÐ’Ð£Ð„ÐœÐž GEMINI 1.5 FLASH (ÑÑ‚Ð°Ð±Ñ–Ð»ÑŒÐ½Ñ–ÑˆÐ°)
        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }]
                })
            }
        );

        const data = await response.json();

        // ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° Ð¿Ð¾Ð¼Ð¸Ð»Ð¾Ðº Ð²Ñ–Ð´ Google
        if (!response.ok) {
            console.error("Gemini error:", data);
            
            // Ð¯ÐºÑ‰Ð¾ Ð»Ñ–Ð¼Ñ–Ñ‚ Ð²Ð¸Ñ‡ÐµÑ€Ð¿Ð°Ð½Ð¾ (ÐºÐ¾Ð´ 429)
            if (response.status === 429) {
                return res.status(429).json({ 
                    error: "ÐŸÐµÑ€ÐµÐ²Ð¸Ñ‰ÐµÐ½Ð¾ Ð»Ñ–Ð¼Ñ–Ñ‚ Ð·Ð°Ð¿Ð¸Ñ‚Ñ–Ð² Ð´Ð¾ Ð¨Ð†. Ð‘ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°, Ð·Ð°Ñ‡ÐµÐºÐ°Ð¹Ñ‚Ðµ Ñ…Ð²Ð¸Ð»Ð¸Ð½Ñƒ Ñ– ÑÐ¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð·Ð½Ð¾Ð²Ñƒ." 
                });
            }

            return res.status(500).json({ error: "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ð²Ñ–Ð´ Gemini: " + (data.error?.message || response.statusText) });
        }

        const dietText = data?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!dietText) {
            return res.status(500).json({ error: "ÐŸÐ¾Ñ€Ð¾Ð¶Ð½Ñ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ð²Ñ–Ð´ Ð¨Ð†" });
        }

        res.json({ diet: dietText });

    } catch (err) {
        console.error("SERVER ERROR:", err);
        res.status(500).json({ error: "Ð’Ð½ÑƒÑ‚Ñ€Ñ–ÑˆÐ½Ñ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°" });
    }
});

app.listen(PORT, () => {
    console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${PORT}`);
});