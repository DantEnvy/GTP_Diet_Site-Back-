import express from 'express';
const express = require('express');
const cors = require('cors');
require('dotenv').config(); // ะะฐะฒะฐะฝัะฐะถัั ะทะผัะฝะฝั ะท ัะฐะนะปั .env

const app = express();

// ะะธะบะพัะธััะพะฒััะผะพ ะฟะพัั ัะท ัะตัะตะดะพะฒะธัะฐ (ะดะปั Render) ะฐะฑะพ 3000 ะดะปั ะปะพะบะฐะปัะฝะพะณะพ ะทะฐะฟััะบั
const PORT = process.env.PORT || 3000;

// ะะฐะปะฐัััะฒะฐะฝะฝั ะฑะตะทะฟะตะบะธ ัะฐ ะพะฑัะพะฑะบะธ ะดะฐะฝะธั
app.use(cors()); // ะะพะทะฒะพะปัั ะทะฐะฟะธัะธ ะท ะฑัะฐัะทะตัะฐ
app.use(express.json()); // ะะพะทะฒะพะปัั ัะธัะฐัะธ JSON, ัะบะธะน ะฝะฐะดัะธะปะฐั ััะพะฝัะตะฝะด

// --- ะะะะะะะะ ะะะะจะะฃะข ---
app.post('/api/diet', async (req, res) => {
    try {
        console.log("ะััะธะผะฐะฝะพ ะทะฐะฟะธั:", req.body); // ะะพะณัะฒะฐะฝะฝั ะดะปั ะฟะตัะตะฒััะบะธ

        // 1. ะััะธะผััะผะพ ะดะฐะฝั ะฒัะด ััะพะฝัะตะฝะดั
        const { bmr, protein, fat, carb, allergy, health } = req.body;

        // ะะตัะตะฒััะบะฐ ะฝะฐัะฒะฝะพััั ะบะปััะฐ
        if (!process.env.GOOGLE_API_KEY) {
            throw new Error("GOOGLE_API_KEY ะฝะต ะทะฝะฐะนะดะตะฝะพ ั ัะฐะนะปั .env");
        }

        // 2. ะคะพัะผััะผะพ ัะตะบัั ะทะฐะฟะธัั (ะัะพะผะฟั)
        const promptText = `
            ะขะธ ะฟัะพัะตััะนะฝะธะน ะดัััะพะปะพะณ. ะกัะฒะพัะธ ะดะตัะฐะปัะฝะธะน ะฟะปะฐะฝ ัะฐัััะฒะฐะฝะฝั (ะผะตะฝั) ะฝะฐ ะพะดะธะฝ ะดะตะฝั ัะบัะฐัะฝััะบะพั ะผะพะฒะพั.
            
            ะะฐะฝั ะบะปััะฝัะฐ:
            - ะะพะฑะพะฒะฐ ะฝะพัะผะฐ ะบะฐะปะพััะน: ${bmr} ะบะบะฐะป
            - ะัะปะบะธ: ${protein} ะณ
            - ะะธัะธ: ${fat} ะณ
            - ะัะณะปะตะฒะพะดะธ: ${carb} ะณ
            - ะะปะตัะณัั: ${allergy || "ะฝะตะผะฐั"}
            - ะัะพะฑะปะธะฒะพััั ะทะดะพัะพะฒ'ั: ${health || "ะฝะตะผะฐั"}
            
            ะะฐะฒะดะฐะฝะฝั:
            1. ะะพะทะฟะธัะธ ะกะฝัะดะฐะฝะพะบ, ะะฑัะด, ะะตัะตัั ัะฐ 1-2 ะฟะตัะตะบััะธ.
            2. ะะปั ะบะพะถะฝะพะณะพ ะฟัะธะนะพะผั ัะถั ะฒะบะฐะถะธ ะบะพะฝะบัะตัะฝั ัััะฐะฒะธ ัะฐ ะฒะฐะณั ะฟัะพะดัะบััะฒ (ั ะณัะฐะผะฐั).
            3. ะคะพัะผะฐั ะฒัะดะฟะพะฒัะดั ะผะฐั ะฑััะธ ัััะบะธะผ, ััััะบัััะพะฒะฐะฝะธะผ ัะตะบััะพะผ (ะผะพะถะฝะฐ ะฒะธะบะพัะธััะพะฒัะฒะฐัะธ Markdown).
            4. ะัะฐััะน ะฒะบะฐะทะฐะฝั ะฐะปะตัะณัั (ะฒะธะบะปััะธ ัั ะฟัะพะดัะบัะธ) ัะฐ ัะตะบะพะผะตะฝะดะฐััั ัะพะดะพ ะทะดะพัะพะฒ'ั.
        `;

        // 3. ะัะดะฟัะฐะฒะปััะผะพ ะทะฐะฟะธั ะดะพ Google Gemini API
        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${process.env.GOOGLE_API_KEY}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }]
                })
            }
        );

        const data = await response.json();

        // 4. ะะฑัะพะฑะปััะผะพ ะฒัะดะฟะพะฒัะดั
        if (response.ok && data.candidates && data.candidates.length > 0) {
            const dietText = data.candidates[0].content.parts[0].text;
            
            // ะัะดะฟัะฐะฒะปััะผะพ ัะตะบัั ะฝะฐะทะฐะด ะฝะฐ ััะพะฝัะตะฝะด
            res.status(200).json({ diet: dietText });
        } else {
            console.error("ะะพะผะธะปะบะฐ ะฒัะด Google Gemini:", data);
            res.status(500).json({ error: "ะะต ะฒะดะฐะปะพัั ะพััะธะผะฐัะธ ะฒัะดะฟะพะฒัะดั ะฒัะด ะจะ. ะะตัะตะฒัััะต ะปัะผััะธ ะฐะฑะพ ะบะปัั." });
        }

    } catch (error) {
        console.error("ะะฝัััััะฝั ะฟะพะผะธะปะบะฐ ัะตัะฒะตัะฐ:", error.message);
        res.status(500).json({ error: "ะกัะฐะปะฐัั ะฟะพะผะธะปะบะฐ ะฝะฐ ัะตัะฒะตัั." });
    }
});

// --- ะะะะฃะกะ ะกะะะะะะ ---
app.listen(PORT, () => {
    console.log(`๐ ะกะตัะฒะตั ััะฟััะฝะพ ะทะฐะฟััะตะฝะพ!`);
    console.log(`๐ก ะกะปััะฐัะผะพ ะฟะพัั: ${PORT}`);
    console.log(`๐ ะะพะบะฐะปัะฝะฐ ะฐะดัะตัะฐ: http://localhost:${PORT}`);
});