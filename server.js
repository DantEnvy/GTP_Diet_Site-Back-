import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
// import fetch from 'node-fetch'; // –Ø–∫—â–æ –≤–∏–Ω–∏–∫–∞—î –ø–æ–º–∏–ª–∫–∞ "fetch is not defined" –Ω–∞ —Å—Ç–∞—Ä–∏—Ö –Ω–æ–¥–∞—Ö, —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ —Ü–µ (–ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –∑—Ä–æ–±–∏–≤—à–∏ npm install node-fetch)
// –ê–ª–µ –Ω–∞ Node 18+ fetch –≤–±—É–¥–æ–≤–∞–Ω–∏–π.

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());

app.post('/', async (req, res) => { 
    try {
        console.log("–û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç:", req.body);
        const { age, height, weight, gender, bmr, protein, fat, carb, allergy, health, vitamins } = req.body;
        const API_KEY = process.env.GOOGLE_API_KEY; 
        
        if (!API_KEY) {
            return res.status(500).json({ error: "GOOGLE_API_KEY –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ" });
        }

        const promptText = `

–¢–∏ —î –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–º –¥—ñ—î—Ç–æ–ª–æ–≥–æ–º —ñ –Ω—É—Ç—Ä–∏—Ü—ñ–æ–ª–æ–≥–æ–º. –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –∑ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–∞–¥–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö –ª—é–¥–∏–Ω–∏.

–í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:
–í—ñ–∫: ${age}
–ó—Ä—ñ—Å—Ç: ${height} —Å–º
–í–∞–≥–∞: ${weight} –∫–≥
–°—Ç–∞—Ç—å: ${gender}
–ê–ª–µ—Ä–≥—ñ—ó: ${allergy}
–°—Ç–∞–Ω –∑–¥–æ—Ä–æ–≤'—è: ${health}
–î–æ–±–æ–≤—ñ –Ω–æ—Ä–º–∏:
–ö–∞–ª–æ—Ä—ñ—ó: ${bmr} –∫–∫–∞–ª
–ë—ñ–ª–∫–∏: ${protein} –≥
–ñ–∏—Ä–∏: ${fat} –≥
–í—É–≥–ª–µ–≤–æ–¥–∏: ${carb} –≥
–í—ñ—Ç–∞–º—ñ–Ω–∏ —Ç–∞ –º—ñ–∫—Ä–æ–µ–ª–µ–º–µ–Ω—Ç–∏ –Ω–∞ –¥–µ–Ω—å: ${vitamins}

–ó–∞–≤–¥–∞–Ω–Ω—è:
–ù–∞ –æ—Å–Ω–æ–≤—ñ —Ü–∏—Ö –¥–∞–Ω–∏—Ö —Å–∫–ª–∞–¥–∏ –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π —Ä–∞—Ü—ñ–æ–Ω —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è –Ω–∞ 7 –¥–Ω—ñ–≤.

–ö–æ–∂–µ–Ω –¥–µ–Ω—å –ø–æ–≤–∏–Ω–µ–Ω –º—ñ—Å—Ç–∏—Ç–∏ —Å–Ω—ñ–¥–∞–Ω–æ–∫, –æ–±—ñ–¥, –≤–µ—á–µ—Ä—é —Ç–∞ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏ 1‚Äì2 –ø–µ—Ä–µ–∫—É—Å–∏.

–î–ª—è –∫–æ–∂–Ω–æ—ó —Å—Ç—Ä–∞–≤–∏ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –≤–∫–∞–∑—É–π:
–ù–∞–∑–≤—É —Å—Ç—Ä–∞–≤–∏.
–°–∫–ª–∞–¥ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ —ñ–∑ —Ç–æ—á–Ω–∏–º–∏ –≤–∞–≥–∞–º–∏.
–ö–∞–ª–æ—Ä—ñ–π–Ω—ñ—Å—Ç—å.
–ö—ñ–ª—å–∫—ñ—Å—Ç—å –±—ñ–ª–∫—ñ–≤, –∂–∏—Ä—ñ–≤ —ñ –≤—É–≥–ª–µ–≤–æ–¥—ñ–≤.
–û—Å–Ω–æ–≤–Ω—ñ –≤—ñ—Ç–∞–º—ñ–Ω–∏ —Ç–∞ –º—ñ–Ω–µ—Ä–∞–ª–∏, —è–∫—ñ –º—ñ—Å—Ç—è—Ç—å—Å—è —É —Å—Ç—Ä–∞–≤—ñ.

–°—É–º–∞—Ä–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –∑–∞ –¥–µ–Ω—å –ø–æ–≤–∏–Ω–Ω—ñ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –∑–∞–¥–∞–Ω–∏–º –Ω–æ—Ä–º–∞–º –∫–∞–ª–æ—Ä—ñ–π, –±—ñ–ª–∫—ñ–≤, –∂–∏—Ä—ñ–≤ —ñ –≤—É–≥–ª–µ–≤–æ–¥—ñ–≤. –†–∞—Ü—ñ–æ–Ω –º–∞—î –ø–æ–∫—Ä–∏–≤–∞—Ç–∏ –¥–æ–±–æ–≤—É –ø–æ—Ç—Ä–µ–±—É —É –≤—ñ—Ç–∞–º—ñ–Ω–∞—Ö –±–µ–∑ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è –±–µ–∑–ø–µ—á–Ω–∏—Ö –¥–æ–∑.

–°—Ç—Ä–æ–≥–æ –≤–∏–∫–ª—é—á–∏ –≤—Å—ñ –ø—Ä–æ–¥—É–∫—Ç–∏, —è–∫—ñ –Ω–µ –º–æ–∂–Ω–∞ –≤–∂–∏–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ –∞–ª–µ—Ä–≥—ñ—ó, –∑–∞—Ö–≤–æ—Ä—é–≤–∞–Ω–Ω—è –∞–±–æ —Ç—Ä–∞–≤–º–∏.

–†–∞—Ü—ñ–æ–Ω –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º, —Å–∫–ª–∞–¥–∞—Ç–∏—Å—è –∑—ñ –∑–≤–∏—á–∞–π–Ω–∏—Ö –ø—Ä–æ–¥—É–∫—Ç—ñ–≤, –Ω–µ –º—ñ—Å—Ç–∏—Ç–∏ –µ–∫–∑–æ—Ç–∏—á–Ω–∏—Ö –∞–±–æ –Ω–∞–¥—Ç–æ –¥–æ—Ä–æ–≥–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤, –±—É—Ç–∏ –∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∏–º —ñ —Ä—ñ–∑–Ω–æ–º–∞–Ω—ñ—Ç–Ω–∏–º.

–§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:
–û–∫—Ä–µ–º–∏–π –±–ª–æ–∫ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è –∑ –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è–º –î–µ–Ω—å 1 ‚Äì –î–µ–Ω—å 7.
–ß—ñ—Ç–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–±–æ —Ç–∞–±–ª–∏—Ü—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è.
–í –∫—ñ–Ω—Ü—ñ –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è –Ω–∞–¥–∞–π –ø—ñ–¥—Å—É–º–æ–∫ –∑–∞ –¥–µ–Ω—å: –∫–∞–ª–æ—Ä—ñ—ó, –±—ñ–ª–∫–∏, –∂–∏—Ä–∏, –≤—É–≥–ª–µ–≤–æ–¥–∏.
–ü—ñ—Å–ª—è –≤—Å—å–æ–≥–æ —Ä–∞—Ü—ñ–æ–Ω—É –¥–æ–¥–∞–π –∫–æ—Ä–æ—Ç–∫—ñ –∑–∞–≥–∞–ª—å–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —â–æ–¥–æ –≤–æ–¥–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É —Ç–∞ –º–æ–∂–ª–∏–≤–∏—Ö –∑–∞–º—ñ–Ω –ø—Ä–æ–¥—É–∫—Ç—ñ–≤.

–ù–µ –Ω–∞–¥–∞–≤–∞–π –º–µ–¥–∏—á–Ω–∏—Ö –ø–æ—Ä–∞–¥, –ª–∏—à–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –∑ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è.
–Ø–∫—â–æ —è–∫–∏—Ö–æ—Å—å –¥–∞–Ω–∏—Ö –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î, —è–≤–Ω–æ –≤–∫–∞–∂–∏ –∑—Ä–æ–±–ª–µ–Ω—ñ –ø—Ä–∏–ø—É—â–µ–Ω–Ω—è.

–í–∏–≤–µ–¥–∏ —É JSON —Ñ–æ—Ä–º–∞—Ç—ñ`;
        // –í–ò–ö–û–†–ò–°–¢–û–í–£–Ñ–ú–û GEMINI 1.5 FLASH (—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à–∞)
        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
            contents: [{ parts: [{ text: promptText }] }],
            // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç—É –Ω–∞—Å—Ç—Ä–æ–π–∫—É, —á—Ç–æ–±—ã –ò–ò —Ç–æ—á–Ω–æ –≤–µ—Ä–Ω—É–ª JSON
            generationConfig: {
                responseMimeType: "application/json"
            }
        })
            }
        );

        const data = await response.json();

        // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –≤—ñ–¥ Google
        if (!response.ok) {
            console.error("Gemini error:", data);
            
            // –Ø–∫—â–æ –ª—ñ–º—ñ—Ç –≤–∏—á–µ—Ä–ø–∞–Ω–æ (–∫–æ–¥ 429)
            if (response.status === 429) {
                return res.status(429).json({ 
                    error: "–ü–µ—Ä–µ–≤–∏—â–µ–Ω–æ –ª—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ –®–Ü. –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞—á–µ–∫–∞–π—Ç–µ —Ö–≤–∏–ª–∏–Ω—É —ñ —Å–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É." 
                });
            }

            return res.status(500).json({ error: "–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ Gemini: " + (data.error?.message || response.statusText) });
        }

        const dietText = data?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!dietText) {
            return res.status(500).json({ error: "–ü–æ—Ä–æ–∂–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –®–Ü" });
        }

        res.json({ diet: dietText });

    } catch (err) {
        console.error("SERVER ERROR:", err);
        res.status(500).json({ error: "–í–Ω—É—Ç—Ä—ñ—à–Ω—è –ø–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞" });
    }
});

app.listen(PORT, () => {
    console.log(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
});






/* –¢–∏ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –¥—ñ—î—Ç–æ–ª–æ–≥. –°—Ç–≤–æ—Ä–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π –ø–ª–∞–Ω —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è (–º–µ–Ω—é) –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.

–î–∞–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∞:
- –î–æ–±–æ–≤–∞ –Ω–æ—Ä–º–∞ –∫–∞–ª–æ—Ä—ñ–π: ${bmr} –∫–∫–∞–ª
- –ë—ñ–ª–∫–∏: ${protein} –≥
- –ñ–∏—Ä–∏: ${fat} –≥
- –í—É–≥–ª–µ–≤–æ–¥–∏: ${carb} –≥
- –ê–ª–µ—Ä–≥—ñ—ó: ${allergy || "–Ω–µ–º–∞—î"}
- –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –∑–¥–æ—Ä–æ–≤'—è: ${health || "–Ω–µ–º–∞—î"}

–ó–∞–≤–¥–∞–Ω–Ω—è:
1. –°–Ω—ñ–¥–∞–Ω–æ–∫, –û–±—ñ–¥, –í–µ—á–µ—Ä—è + 1‚Äì2 –ø–µ—Ä–µ–∫—É—Å–∏
2. –í–∫–∞–∑–∞—Ç–∏ –≤–∞–≥—É –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ (–≥)
3. –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π Markdown
4. –í—Ä–∞—Ö—É–≤–∞—Ç–∏ –∞–ª–µ—Ä–≥—ñ—ó
        */